# Two-Person All Clear Workflow - Visual Diagrams

## System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SafeSignal System                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ESP32      â”‚  MQTT   â”‚    Edge      â”‚  HTTP   â”‚   Cloud      â”‚
â”‚   Button     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Policy     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Backend    â”‚
â”‚              â”‚ (TLS)   â”‚   Service    â”‚ (REST)  â”‚   API        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â”‚ REST API
                                                          â”‚
                                                   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚    Mobile    â”‚
                                                   â”‚     App      â”‚
                                                   â”‚  (User A/B)  â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Alert Clearance State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Alert Status Transitions                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Alert Triggered  â”‚
              â”‚   (ESP32/Mobile)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚      [NEW]      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                 â”‚               â”‚
              â”‚  No clearances  â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                        â”‚                       â”‚
              User A submits clearance          â”‚
              with location + notes             â”‚
                        â”‚                       â”‚
                        â–¼                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
         â”‚  [PENDING_CLEARANCE]     â”‚           â”‚
         â”‚                          â”‚           â”‚
         â”‚  FirstClearanceUserId    â”‚           â”‚ Attempting 3rd clearance
         â”‚  FirstClearanceAt        â”‚           â”‚ or already resolved
         â”‚                          â”‚           â”‚
         â”‚  Badge: ğŸŸ  1/2          â”‚           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                   â”‚                            â”‚
         User B submits clearance               â”‚
         (different from User A)                â”‚
                   â”‚                            â”‚
                   â–¼                            â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
         â”‚     [RESOLVED]           â”‚           â”‚
         â”‚                          â”‚           â”‚
         â”‚  SecondClearanceUserId   â”‚           â”‚
         â”‚  SecondClearanceAt       â”‚           â”‚
         â”‚  FullyClearedAt          â”‚           â”‚
         â”‚                          â”‚           â”‚
         â”‚  Badge: ğŸŸ¢ 2/2          â”‚           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                    â”‚                           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      (400 Bad Request)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Error Scenarios                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[PENDING_CLEARANCE]
         â”‚
User A tries 2nd clearance (same user)
         â”‚
         â–¼
    âŒ 400 Bad Request
    "Cannot provide second clearance - you already provided the first"


[RESOLVED]
         â”‚
Any user tries to clear
         â”‚
         â–¼
    âŒ 400 Bad Request
    "Alert is already fully resolved"


[Any Status]
         â”‚
User from different organization
         â”‚
         â–¼
    âŒ 404 Not Found
    (prevents information leakage)
```

---

## Sequence Diagram - Happy Path

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ESP32   â”‚  â”‚  Policy  â”‚  â”‚   API    â”‚  â”‚ Database â”‚  â”‚  Mobile  â”‚
â”‚  Button  â”‚  â”‚ Service  â”‚  â”‚          â”‚  â”‚          â”‚  â”‚ (User A) â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚ Press       â”‚              â”‚             â”‚             â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚             â”‚             â”‚
     â”‚ (MQTT)      â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚ POST /triggerâ”‚             â”‚             â”‚
     â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚              â”‚ INSERT alertâ”‚             â”‚
     â”‚             â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
     â”‚             â”‚              â”‚ (status=New)â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚             â”‚
     â”‚             â”‚ Alert createdâ”‚             â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚ GET /alerts â”‚
     â”‚             â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚ SELECT      â”‚
     â”‚             â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚             â”‚              â”‚ [New alert] â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚              â”‚ POST /clear â”‚             â”‚
     â”‚             â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚             â”‚              â”‚ (notes,     â”‚             â”‚
     â”‚             â”‚              â”‚  location)  â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚              â”‚ INSERT      â”‚             â”‚
     â”‚             â”‚              â”‚ clearance   â”‚             â”‚
     â”‚             â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
     â”‚             â”‚              â”‚ (step=1)    â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚              â”‚ UPDATE alertâ”‚             â”‚
     â”‚             â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
     â”‚             â”‚              â”‚ (status=    â”‚             â”‚
     â”‚             â”‚              â”‚  Pending)   â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚
     â”‚             â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚             â”‚              â”‚ "First      â”‚             â”‚
     â”‚             â”‚              â”‚  clearance  â”‚             â”‚
     â”‚             â”‚              â”‚  recorded"  â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚             â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mobile  â”‚  â”‚   API    â”‚  â”‚ Database â”‚  â”‚  Mobile  â”‚  â”‚          â”‚
â”‚ (User A) â”‚  â”‚          â”‚  â”‚          â”‚  â”‚ (User B) â”‚  â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚              â”‚             â”‚
     â”‚             â”‚              â”‚ GET /alerts â”‚
     â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚             â”‚              â”‚             â”‚
     â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚             â”‚ [Pending    â”‚             â”‚
     â”‚             â”‚  alert 1/2] â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚
     â”‚             â”‚ POST /clear â”‚             â”‚
     â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚             â”‚ (notes,     â”‚             â”‚
     â”‚             â”‚  location)  â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚
     â”‚             â”‚ Check:      â”‚             â”‚
     â”‚             â”‚ User B â‰     â”‚             â”‚
     â”‚             â”‚ User A? âœ…  â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚
     â”‚             â”‚ INSERT      â”‚             â”‚
     â”‚             â”‚ clearance   â”‚             â”‚
     â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
     â”‚             â”‚ (step=2)    â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚
     â”‚             â”‚ UPDATE alertâ”‚             â”‚
     â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
     â”‚             â”‚ (status=    â”‚             â”‚
     â”‚             â”‚  Resolved)  â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚
     â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚             â”‚ "Second     â”‚             â”‚
     â”‚             â”‚  clearance  â”‚             â”‚
     â”‚             â”‚  recorded.  â”‚             â”‚
     â”‚             â”‚  Alert      â”‚             â”‚
     â”‚             â”‚  resolved"  â”‚             â”‚
     â”‚             â”‚              â”‚             â”‚
```

---

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Clearance Submission Flow                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Mobile App (User)
      â”‚
      â”‚ 1. Request location permission
      â”‚
      â–¼
expo-location API
      â”‚
      â”‚ 2. Capture GPS coordinates
      â”‚    (latitude, longitude, accuracy, altitude)
      â”‚
      â–¼
AlertClearanceScreen
      â”‚
      â”‚ 3. Collect user notes (text)
      â”‚
      â–¼
API Client (apiClient.clearAlert)
      â”‚
      â”‚ 4. POST /api/alerts/{id}/clear
      â”‚    {
      â”‚      notes: "...",
      â”‚      location: {lat, lng, accuracy}
      â”‚    }
      â”‚
      â–¼
Backend API (AlertsController)
      â”‚
      â”‚ 5. Validate JWT token
      â”‚    Verify organization access
      â”‚    Check alert status
      â”‚
      â”œâ”€â”€â”€â”€â”€â–º 6. Determine clearance step
      â”‚         - New/Acknowledged â†’ step 1
      â”‚         - PendingClearance â†’ step 2
      â”‚         - Resolved â†’ ERROR 400
      â”‚
      â”œâ”€â”€â”€â”€â”€â–º 7. Validate same-user prevention
      â”‚         if (step 2 && user == firstUser)
      â”‚           â†’ ERROR 400
      â”‚
      â–¼
AlertClearance Entity
      â”‚
      â”‚ 8. Create clearance record
      â”‚    {
      â”‚      alertId, userId, step,
      â”‚      clearedAt, notes, location (JSONB)
      â”‚    }
      â”‚
      â–¼
Database (PostgreSQL)
      â”‚
      â”œâ”€â”€â”€â”€â”€â–º 9a. INSERT alert_clearances
      â”‚
      â””â”€â”€â”€â”€â”€â–º 9b. UPDATE alerts
                    - step 1: status = PendingClearance,
                              firstClearanceUserId = user,
                              firstClearanceAt = now
                    - step 2: status = Resolved,
                              secondClearanceUserId = user,
                              secondClearanceAt = now,
                              fullyClearedAt = now,
                              resolvedAt = now
      â”‚
      â–¼
AuditService
      â”‚
      â”‚ 10. Log clearance action
      â”‚     {
      â”‚       userId, organizationId, action,
      â”‚       entityType: "Alert",
      â”‚       additionalInfo: {step, status, notes}
      â”‚     }
      â”‚
      â–¼
Response to Mobile
      â”‚
      â”‚ 11. Return clearance confirmation
      â”‚     {
      â”‚       status, message, clearanceStep,
      â”‚       firstClearance, secondClearance
      â”‚     }
      â”‚
      â–¼
Mobile App UI
      â”‚
      â”‚ 12. Display success message
      â”‚     Navigate back to history
      â”‚     Refresh alert list
      â”‚
      â–¼
AlertHistoryScreen
      â”‚
      â”‚ 13. Show updated badge
      â”‚     - PendingClearance â†’ ğŸŸ  1/2
      â”‚     - Resolved â†’ ğŸŸ¢ 2/2
```

---

## Database Schema Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Database Entity Diagram                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   organizations      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)              â”‚
â”‚ name                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1:N
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       users          â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)              â”‚
â”‚ organization_id (FK) â”‚
â”‚ email                â”‚
â”‚ first_name           â”‚
â”‚ last_name            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1:N
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            alerts                    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)                              â”‚
â”‚ alert_id                             â”‚
â”‚ organization_id (FK)                 â”‚
â”‚ status                               â”‚
â”‚ triggered_at                         â”‚
â”‚ resolved_at                          â”‚
â”‚ first_clearance_user_id (FKâ†’users)   â”‚â—„â”€â”€â”
â”‚ first_clearance_at                   â”‚   â”‚ Denormalized
â”‚ second_clearance_user_id (FKâ†’users)  â”‚â—„â”€â”€â”¤ for fast queries
â”‚ second_clearance_at                  â”‚   â”‚
â”‚ fully_cleared_at                     â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â”‚                                 â”‚
          â”‚ 1:N                             â”‚
          â”‚                                 â”‚
          â–¼                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  alert_clearances        â”‚               â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
â”‚ id (PK)                  â”‚               â”‚
â”‚ alert_id (FKâ†’alerts)     â”‚               â”‚
â”‚ user_id (FKâ†’users)       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ organization_id (FK)     â”‚
â”‚ clearance_step (1 or 2)  â”‚
â”‚ cleared_at               â”‚
â”‚ notes                    â”‚
â”‚ location (JSONB)         â”‚
â”‚ device_info              â”‚
â”‚ created_at               â”‚
â”‚                          â”‚
â”‚ UNIQUE(alert_id, step)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      audit_logs          â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)                  â”‚
â”‚ user_id (FKâ†’users)       â”‚
â”‚ organization_id (FK)     â”‚
â”‚ action                   â”‚
â”‚ entity_type              â”‚
â”‚ entity_id                â”‚
â”‚ category                 â”‚
â”‚ success                  â”‚
â”‚ additional_info (JSONB)  â”‚
â”‚ created_at               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Mobile App Screen Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Mobile App Navigation                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AlertHistoryScreen     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Alert #1234        â”‚ â”‚
â”‚  â”‚ Building A         â”‚ â”‚
â”‚  â”‚ 2 mins ago   ğŸŸ  1/2 â”‚â—„â”€â”€â”€ PendingClearance badge
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Alert #1235        â”‚ â”‚
â”‚  â”‚ Building B         â”‚ â”‚
â”‚  â”‚ 10 mins ago  ğŸŸ¢ 2/2 â”‚â—„â”€â”€â”€ Resolved badge
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Alert #1236        â”‚ â”‚
â”‚  â”‚ Building A         â”‚ â”‚
â”‚  â”‚ 1 hour ago         â”‚â—„â”€â”€â”€ New (no badge)
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â”‚  [Pull to Refresh]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ User taps alert
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlertClearanceScreen    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                         â”‚
â”‚  Alert Details:         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Alert ID: #1234    â”‚ â”‚
â”‚  â”‚ Building: A        â”‚ â”‚
â”‚  â”‚ Time: 2 mins ago   â”‚ â”‚
â”‚  â”‚ Status: Pending 1/2â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â”‚  First Clearance:       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ John Doe           â”‚ â”‚
â”‚  â”‚ 2025-11-04 10:30   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â”‚  Your Clearance:        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“ Location:       â”‚ â”‚
â”‚  â”‚ 37.7749, -122.4194 â”‚ â”‚
â”‚  â”‚ Accuracy: 5m       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Notes:             â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚                â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ (multiline)    â”‚ â”‚ â”‚
â”‚  â”‚ â”‚                â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Submit Clearance   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ After submission
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Success Message        â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                         â”‚
â”‚  âœ… Clearance Recorded! â”‚
â”‚                         â”‚
â”‚  "Second clearance      â”‚
â”‚   recorded. Alert       â”‚
â”‚   fully resolved."      â”‚
â”‚                         â”‚
â”‚  [Back to History]      â”‚
â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Navigate back
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AlertHistoryScreen     â”‚
â”‚  (Refreshed)            â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Alert #1234        â”‚ â”‚
â”‚  â”‚ Building A         â”‚ â”‚
â”‚  â”‚ 5 mins ago   ğŸŸ¢ 2/2 â”‚â—„â”€â”€â”€ Updated to Resolved
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Permission Flow (iOS/Android)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Location Permission Handling                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AlertClearanceScreen.useEffect()
      â”‚
      â”‚ Request location permission
      â”‚
      â–¼
Location.requestForegroundPermissionsAsync()
      â”‚
      â”œâ”€â”€â”€â”€â”€â–º Permission GRANTED âœ…
      â”‚         â”‚
      â”‚         â–¼
      â”‚       Location.getCurrentPositionAsync()
      â”‚         â”‚
      â”‚         â–¼
      â”‚       Display coordinates on screen
      â”‚       {latitude, longitude, accuracy}
      â”‚         â”‚
      â”‚         â–¼
      â”‚       Enable "Submit Clearance" button
      â”‚
      â””â”€â”€â”€â”€â”€â–º Permission DENIED âŒ
                â”‚
                â–¼
              Display error message
              "Location permission is required"
                â”‚
                â–¼
              Disable "Submit Clearance" button
                â”‚
                â–¼
              User can:
              1. Go to Settings â†’ Grant permission
              2. Return to app â†’ useEffect re-runs â†’ Permission granted
```

---

## Audit Trail Example

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Audit Log Entries for Alert Clearance                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Entry 1: First Clearance
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id:         uuid-user-a                           â”‚
â”‚ organization_id: uuid-org-1                            â”‚
â”‚ action:          "Alert clearance step 1"              â”‚
â”‚ entity_type:     "Alert"                               â”‚
â”‚ entity_id:       uuid-alert-123                        â”‚
â”‚ category:        Alert                                 â”‚
â”‚ success:         true                                  â”‚
â”‚ additional_info: {                                     â”‚
â”‚   "AlertId": "alert-123",                              â”‚
â”‚   "ClearanceStep": 1,                                  â”‚
â”‚   "Status": "PendingClearance",                        â”‚
â”‚   "Notes": "Room checked - false alarm"               â”‚
â”‚ }                                                      â”‚
â”‚ created_at:      2025-11-04T10:30:00Z                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Entry 2: Second Clearance
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id:         uuid-user-b                           â”‚
â”‚ organization_id: uuid-org-1                            â”‚
â”‚ action:          "Alert clearance step 2"              â”‚
â”‚ entity_type:     "Alert"                               â”‚
â”‚ entity_id:       uuid-alert-123                        â”‚
â”‚ category:        Alert                                 â”‚
â”‚ success:         true                                  â”‚
â”‚ additional_info: {                                     â”‚
â”‚   "AlertId": "alert-123",                              â”‚
â”‚   "ClearanceStep": 2,                                  â”‚
â”‚   "Status": "Resolved",                                â”‚
â”‚   "Notes": "Double-checked - confirmed safe"          â”‚
â”‚ }                                                      â”‚
â”‚ created_at:      2025-11-04T10:35:00Z                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Entry 3: Failed Attempt (Same User)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id:         uuid-user-a                           â”‚
â”‚ organization_id: uuid-org-1                            â”‚
â”‚ action:          "Alert clearance attempt failed"      â”‚
â”‚ entity_type:     "Alert"                               â”‚
â”‚ entity_id:       uuid-alert-123                        â”‚
â”‚ category:        Alert                                 â”‚
â”‚ success:         false                                 â”‚
â”‚ additional_info: {                                     â”‚
â”‚   "AlertId": "alert-123",                              â”‚
â”‚   "Error": "Same user prevention",                     â”‚
â”‚   "Reason": "User already provided first clearance"   â”‚
â”‚ }                                                      â”‚
â”‚ created_at:      2025-11-04T10:36:00Z                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Last Updated**: 2025-11-04
**Version**: 1.0
**Purpose**: Visual reference for two-person All Clear workflow
