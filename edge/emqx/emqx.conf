## SafeSignal Edge - EMQX Configuration (Dev)
##
## MQTT v5 broker with mTLS enforcement and per-tenant ACL
## ⚠️  Development configuration - not for production use

##--------------------------------------------------------------------
## Node Configuration
##--------------------------------------------------------------------
node.name = emqx@127.0.0.1
node.cookie = safesignal_dev_cookie_change_in_prod
node.data_dir = /opt/emqx/data

##--------------------------------------------------------------------
## Cluster Configuration (single node for MVP)
##--------------------------------------------------------------------
cluster.discovery = static
cluster.static.seeds = []

##--------------------------------------------------------------------
## Listeners - MQTT over TLS with mTLS
##--------------------------------------------------------------------

## Disable non-TLS listeners for security
listener.tcp.default = off
listener.ws.default = off

## MQTT over TLS with mTLS (port 8883)
listener.ssl.default = 8883
listener.ssl.default.acceptors = 8
listener.ssl.default.max_connections = 1024000
listener.ssl.default.max_conn_rate = 1000

## mTLS Configuration
listener.ssl.default.ssl_options.cacertfile = /opt/emqx/etc/certs/ca/ca.crt
listener.ssl.default.ssl_options.certfile = /opt/emqx/etc/certs/emqx/server.crt
listener.ssl.default.ssl_options.keyfile = /opt/emqx/etc/certs/emqx/server.key
listener.ssl.default.ssl_options.verify = verify_peer
listener.ssl.default.ssl_options.fail_if_no_peer_cert = true
listener.ssl.default.ssl_options.versions = tlsv1.3,tlsv1.2

## Extract client ID from certificate CN
listener.ssl.default.peer_cert_as_username = cn

##--------------------------------------------------------------------
## MQTT Protocol Configuration
##--------------------------------------------------------------------

## MQTT Protocol Version
mqtt.max_packet_size = 256KB
mqtt.max_clientid_len = 128
mqtt.max_topic_levels = 10

## QoS Configuration
mqtt.max_qos_allowed = 1
mqtt.retain_available = false  # No retained messages (safety requirement)
mqtt.max_topic_alias = 10

## Session Configuration
mqtt.max_inflight = 32
mqtt.max_awaiting_rel = 100

## Message Expiry
mqtt.max_mqueue_len = 1000
mqtt.mqueue_store_qos0 = false

##--------------------------------------------------------------------
## Security & Authentication
##--------------------------------------------------------------------

## SECURITY: Require authentication (mTLS cert validation enforced)
## IMPORTANT: This file setting must match EMQX_ALLOW_ANONYMOUS env var
allow_anonymous = false

## ACL Configuration
## NOTE: EMQX 5.x file-based ACLs disabled - configure via dashboard or database
## TODO: Migrate to EMQX 5.x authorization API (HTTP server or built-in database)
## For MVP, we rely on mTLS certificate validation for authentication
## Production requires proper authorization rules via dashboard
# authorization.sources = [
#   {
#     type = file
#     path = "/opt/emqx/etc/acl.conf"
#     enable = true
#   }
# ]

authorization.no_match = deny
authorization.deny_action = ignore
authorization.cache.enable = true
authorization.cache.max_size = 10000
authorization.cache.ttl = 1m

##--------------------------------------------------------------------
## Zone Configuration
##--------------------------------------------------------------------

## Rate Limiting (per-client)
zone.external.publish_limit = 100,10s  # Max 100 msgs per 10s
zone.external.max_subscriptions = 50
zone.external.max_inflight = 32

## Connection limits
zone.external.idle_timeout = 30s
zone.external.max_packet_size = 256KB

##--------------------------------------------------------------------
## Log Configuration
##--------------------------------------------------------------------

log.level = info
log.to = console

## Structured JSON logging for observability
log.formatter = json

##--------------------------------------------------------------------
## Metrics & Monitoring
##--------------------------------------------------------------------

## Prometheus Metrics
prometheus.enable = true
prometheus.push_gateway_server = http://prometheus:9091
prometheus.interval = 15s

## Stats
stats.enable = true

##--------------------------------------------------------------------
## Plugins
##--------------------------------------------------------------------

## Enable required plugins
plugins.loaded_file = /opt/emqx/data/loaded_plugins

##--------------------------------------------------------------------
## Anti-Replay Protection (application-level)
##--------------------------------------------------------------------
## Note: Anti-replay validation (nonce + timestamp) is handled
## by the policy-service application layer, not EMQX

##--------------------------------------------------------------------
## Performance Tuning
##--------------------------------------------------------------------

## System tuning for low-latency
listener.ssl.default.tune_buffer = on
listener.ssl.default.nodelay = true
listener.ssl.default.reuseaddr = true

## Connection backlog
listener.ssl.default.backlog = 1024
