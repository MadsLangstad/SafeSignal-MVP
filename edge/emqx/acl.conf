##--------------------------------------------------------------------
## SafeSignal Edge - EMQX 5.x Access Control List (ACL)
##
## Per-tenant topic isolation with strict publish/subscribe rules
## Format: {permission, {principal, "value"}, action, ["topics"]}
## EMQX 5.x uses Erlang term syntax
##
## Topic Structure:
##   - Alerts: tenant/{tid}/building/{bid}/room/{rid}/alert
##   - PA Commands: pa/{rid}/play
##   - PA Status: pa/{rid}/status
##   - Device Acks: device/{did}/ack
##
## ⚠️  Development ACL - production requires dynamic per-tenant rules
##--------------------------------------------------------------------

##--------------------------------------------------------------------
## Policy Service (policy-service client cert)
##--------------------------------------------------------------------

%% Can subscribe to all tenant alert topics
{allow, {user, "policy-service"}, subscribe, ["tenant/+/building/+/room/+/alert"]}.

%% Can publish PA commands to all rooms
{allow, {user, "policy-service"}, publish, ["pa/+/play"]}.

%% Can subscribe to PA status from all rooms
{allow, {user, "policy-service"}, subscribe, ["pa/+/status"]}.

%% Can subscribe to device acknowledgements
{allow, {user, "policy-service"}, subscribe, ["device/+/ack"]}.

##--------------------------------------------------------------------
## PA Service (pa-service client cert)
##--------------------------------------------------------------------

%% Can subscribe to PA play commands for all rooms
{allow, {user, "pa-service"}, subscribe, ["pa/+/play"]}.

%% Can publish PA status for all rooms
{allow, {user, "pa-service"}, publish, ["pa/+/status"]}.

##--------------------------------------------------------------------
## ESP32 Devices (device-* certs)
##--------------------------------------------------------------------

%% SECURITY: ESP32 devices RESTRICTED to their specific tenant/building only
%% Wildcard (+) replaced with specific tenant-a/building-a enforcement
%% TODO: Implement dynamic ACL loading per device from database
{allow, {user, "device-esp32-001-tenant-a-building-a"}, publish, ["tenant/tenant-a/building/building-a/room/+/alert"]}.
{allow, {user, "device-esp32-002-tenant-a-building-b"}, publish, ["tenant/tenant-a/building/building-b/room/+/alert"]}.

%% DENY cross-tenant publishing (security invariant)
{deny, {user, "device-esp32-001-tenant-a-building-a"}, publish, ["tenant/tenant-b/#"]}.
{deny, {user, "device-esp32-002-tenant-b-building-a"}, publish, ["tenant/tenant-a/#"]}.

%% ESP32 devices can publish acknowledgements to their own device topic
{allow, {user, "device-esp32-001-tenant-a-building-a"}, publish, ["device/+/ack"]}.
{allow, {user, "device-esp32-002-tenant-a-building-b"}, publish, ["device/+/ack"]}.

%% ESP32 devices can subscribe to their own status/config topics
{allow, {user, "device-esp32-001-tenant-a-building-a"}, subscribe, ["device/+/config"]}.
{allow, {user, "device-esp32-001-tenant-a-building-a"}, subscribe, ["device/+/command"]}.
{allow, {user, "device-esp32-002-tenant-a-building-b"}, subscribe, ["device/+/config"]}.
{allow, {user, "device-esp32-002-tenant-a-building-b"}, subscribe, ["device/+/command"]}.

##--------------------------------------------------------------------
## Mobile App Devices (device-app-* certs)
##--------------------------------------------------------------------

%% SECURITY: Mobile apps RESTRICTED to their specific tenant/building only
{allow, {user, "device-app-001-tenant-a-building-a"}, publish, ["tenant/tenant-a/building/building-a/room/+/alert"]}.
{allow, {user, "device-app-002-tenant-a-building-b"}, publish, ["tenant/tenant-a/building/building-b/room/+/alert"]}.

%% DENY cross-tenant publishing (security invariant)
{deny, {user, "device-app-001-tenant-a-building-a"}, publish, ["tenant/tenant-b/#"]}.
{deny, {user, "device-app-002-tenant-b-building-a"}, publish, ["tenant/tenant-a/#"]}.

%% Mobile apps can subscribe to alert status for their building
{allow, {user, "device-app-001-tenant-a-building-a"}, subscribe, ["tenant/+/building/+/status"]}.
{allow, {user, "device-app-002-tenant-a-building-b"}, subscribe, ["tenant/+/building/+/status"]}.

%% Mobile apps can publish acknowledgements
{allow, {user, "device-app-001-tenant-a-building-a"}, publish, ["device/+/ack"]}.
{allow, {user, "device-app-002-tenant-a-building-b"}, publish, ["device/+/ack"]}.

##--------------------------------------------------------------------
## Test Clients (for development/testing)
##--------------------------------------------------------------------

%% Allow test clients (from cert CN) to publish test alerts
{allow, {user, "test-client"}, publish, ["tenant/+/building/+/room/+/alert"]}.
{allow, {user, "test-client"}, subscribe, ["tenant/+/building/+/#"]}.
{allow, {user, "test-client"}, subscribe, ["pa/+/#"]}.

##--------------------------------------------------------------------
## Deny Rules (safety invariants)
##--------------------------------------------------------------------

%% Deny direct publishing to PA status (only pa-service allowed)
{deny, all, publish, ["pa/+/status"]}.

%% Deny subscribing to other devices' ack topics
{deny, all, subscribe, ["device/+/ack"]}.

##--------------------------------------------------------------------
## Default Deny (fail-safe)
##--------------------------------------------------------------------

%% Deny everything else by default (configured in emqx.conf)
%% authorization.no_match = deny
