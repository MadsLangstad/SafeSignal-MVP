%%--------------------------------------------------------------------
%% SafeSignal Edge - EMQX Access Control List (ACL)
%%
%% Per-tenant topic isolation with strict publish/subscribe rules
%% Format: {allow|deny}, {username|all}, {publish|subscribe|pubsub}, [topics]
%%
%% Topic Structure:
%%   - Alerts: tenant/{tid}/building/{bid}/room/{rid}/alert
%%   - PA Commands: pa/{rid}/play
%%   - PA Status: pa/{rid}/status
%%   - Device Acks: device/{did}/ack
%%
%% ⚠️  Development ACL - production requires dynamic per-tenant rules
%%--------------------------------------------------------------------

%%--------------------------------------------------------------------
%% Policy Service (policy-service client cert)
%%--------------------------------------------------------------------

%% Can subscribe to all tenant alert topics
{allow, "policy-service", subscribe, ["tenant/+/building/+/room/+/alert"]}.

%% Can publish PA commands to all rooms
{allow, "policy-service", publish, ["pa/+/play"]}.

%% Can subscribe to PA status from all rooms
{allow, "policy-service", subscribe, ["pa/+/status"]}.

%% Can subscribe to device acknowledgements
{allow, "policy-service", subscribe, ["device/+/ack"]}.

%%--------------------------------------------------------------------
%% PA Service (pa-service client cert)
%%--------------------------------------------------------------------

%% Can subscribe to PA play commands for all rooms
{allow, "pa-service", subscribe, ["pa/+/play"]}.

%% Can publish PA status for all rooms
{allow, "pa-service", publish, ["pa/+/status"]}.

%%--------------------------------------------------------------------
%% ESP32 Devices (device-* certs)
%%--------------------------------------------------------------------

%% ESP32 devices can publish to their assigned room's alert topic
%% Example: device-esp32-001 can publish to tenant/a/building/b/room/r/alert
%% Note: In production, this should be dynamically mapped per device
{allow, {re, "^device-esp32-.*"}, publish, ["tenant/+/building/+/room/+/alert"]}.

%% ESP32 devices can publish acknowledgements to their own device topic
{allow, {re, "^device-esp32-.*"}, publish, ["device/+/ack"]}.

%% ESP32 devices can subscribe to their own status/config topics
{allow, {re, "^device-esp32-.*"}, subscribe, ["device/+/config"]}.
{allow, {re, "^device-esp32-.*"}, subscribe, ["device/+/command"]}.

%%--------------------------------------------------------------------
%% Mobile App Devices (device-app-* certs)
%%--------------------------------------------------------------------

%% Mobile apps can publish alerts from their assigned room
{allow, {re, "^device-app-.*"}, publish, ["tenant/+/building/+/room/+/alert"]}.

%% Mobile apps can subscribe to alert status for their building
{allow, {re, "^device-app-.*"}, subscribe, ["tenant/+/building/+/status"]}.

%% Mobile apps can publish acknowledgements
{allow, {re, "^device-app-.*"}, publish, ["device/+/ack"]}.

%%--------------------------------------------------------------------
%% Test Clients (for development/testing)
%%--------------------------------------------------------------------

%% Allow test clients (from cert CN) to publish test alerts
{allow, "test-client", publish, ["tenant/+/building/+/room/+/alert"]}.
{allow, "test-client", subscribe, ["tenant/+/building/+/#"]}.
{allow, "test-client", subscribe, ["pa/+/#"]}.

%%--------------------------------------------------------------------
%% Deny Rules (safety invariants)
%%--------------------------------------------------------------------

%% Deny direct publishing to PA status (only pa-service allowed)
{deny, all, publish, ["pa/+/status"]}.

%% Deny subscribing to other devices' ack topics
{deny, all, subscribe, ["device/+/ack"]}.

%% Deny retained messages on any topic (safety requirement)
{deny, all, publish, ["#"], [{retain, eq, true}]}.

%%--------------------------------------------------------------------
%% Default Deny (fail-safe)
%%--------------------------------------------------------------------

%% Deny everything else by default (configured in emqx.conf)
%% authorization.no_match = deny
